---
title: Ajoutez une t√¢che avec HTTP Client
description: D√©couvrez comment ajouter une t√¢che √† une liste √† l'aide du HTTP Client dans une application Angular.
---

import { Steps } from '@astrojs/starlight/components';
import Objective from '../../../../../components/learning-objective.astro';

<Objective class="drop-shadow-xl" objectives={[
    {mainTitle: 'Objectifs de ce chapitre', title: 'Cr√©ez une t√¢che en utilisant HTTP Client', description: 'Ajoutez une t√¢che dans la liste en r√©alisant un appel PI au faux serveur.'},
]} />

## TaskService

Vous venez de communiquer avec le serveur API pour r√©cup√©rer une liste de t√¢ches.
Mettez √† jour la liste stock√©e dans la fausse API en ajoutant une nouvelle t√¢che.

Bas√© sur le protocole HTTP, vous utiliserez la fonction **post** pour ajouter une t√¢che √† la liste : **http.post()**.
Cette fonction attend 2 param√®tres¬†:

1. L'URL du serveur API
2. Les donn√©es de la t√¢che √† envoyer au serveur

```typescript
addTask(task: TaskForm) {
  return this.http.post<Task>('http://localhost:3000/tasks', {
      ...task,
      createdAt: new Date()
  });
}
```

Comme JSON-server est capable de g√©n√©rer un **id** pour nous, vous n'utiliserez pas le package **uuid** pour g√©n√©rer un **id** pour la t√¢che.

Cette nouvelle fonction **addTask** d√©finit l'√©change avec le serveur API¬†:

- Il fait une requ√™te **POST**;
- Il envoie un objet **TaskForm** comme corps de requ√™te;
- Il communique avec le serveur API √† l'adresse `http://localhost:3000/tasks`.

### üéì Instructions

<Steps>

1. Modifiez le fichier `src/app/task.service.ts`.

    ```typescript ins={"Remplacez la fonction addTask": 10-16}
    import { Injectable } from '@angular/core';
    import { HttpClient } from '@angular/common/http';
    import { Task, TaskForm } from './task.model';

    @Injectable({
      providedIn: 'root'
    })
    export class TaskService {
      constructor(private http: HttpClient) { }

      addTask(task: TaskForm) {
        return this.http.post<Task>('http://localhost:3000/tasks', {
          ...task,
          createdAt: new Date()
        });
      }
    }
    ```

</Steps>

## Modifiez TaskFormComponent

√Ä l'√©tape pr√©c√©dente, on vous a expliqu√© que les observables doivent √™tre abonn√©es pour ex√©cuter la requ√™te.
Vous avez pu utiliser le pipe **async** dans le Template HTML pour vous abonner √† l'observable.

Mais dans la situation actuelle, la requ√™te se produit dans le fichier `component.ts`.

Abonnez-nous √† l'observable en utilisant la fonction `subscribe`.

### üéì Instructions

<Steps>

1. Modifiez le fichier `src/app/task-form/task-form.component.ts`.

    ```typescript ins={"Mettez √† jour la fonction de soumission du formulaire": 28-29} ins="this.taskService.addTask(task).subscribe();"
    import { Component } from '@angular/core';
    import { TaskService } from '../task.service';
    import { TaskForm } from '../task.model';

    @Component({
      selector: 'app-task-form',
      templateUrl: './task-form.component.html',
      styleUrls: ['./task-form.component.css']
    })
    export class TaskFormComponent {
      task: TaskForm = {
        title: '',
        description: ''
      };

    constructor(private taskService: TaskService) { }

    submit() {
        const id = this.route.snapshot.paramMap.get('id');

        if (id) {
            const existingTask = this.taskService.getTask(id);
            this.taskService.updateTask({
                ...existingTask,
                ...this.task
            });
        } else {

            this.taskService.addTask(this.task).subscribe();
        }
        this.router.navigate(['/']);
        }
    }
    ```
</Steps>

Cela fonctionne maintenant, mais pas exactement comme vous le souhaiteriez...

## Programmation asynchrone

Vous vous souvenez de l'exemple du journal du chapitre pr√©c√©dent¬†?
√âtant donn√© qu‚Äôil s‚Äôagit d‚Äôun journal physique, sa livraison dans votre bo√Æte aux lettres prend du temps.
Un certain temps s'√©coule entre le moment o√π vous vous inscrivez et le moment o√π vous recevez le journal.

C'est la m√™me chose dans notre situation.
En envoyant une requ√™te avec la fonction **subscribe()**, vous demandez au serveur d'ajouter une t√¢che √† la liste.
Mais la navigation vers l'itin√©raire **"/"** aura lieu imm√©diatement apr√®s l'envoi de la demande, et non une fois la demande termin√©e.

Passons en revue le code que vous venez de modifier dans la fonction `submit` de `TaskFormComponent`¬†:

```typescript
submit() {
    const id = this.route.snapshot.paramMap.get('id');

    if (id) {
        const existingTask = this.taskService.getTask(id);
        this.taskService.updateTask({
                ...existingTask,
                ...this.task
        });
    } else {
        this.taskService.addTask(this.task).subscribe();
    }
    this.router.navigate(['/']);
}
```

1. Vous appelez la fonction **addTask** depuis **TaskService** pour ajouter une t√¢che au serveur API.
2. Vous naviguez vers l'itin√©raire **"/"**.

:::danger
Ce code ne s'ex√©cutera pas dans l'ordre attendu.
:::

La communication API est asynchrone, ce qui signifie que l'action de la fonction **addTask** peut ne pas encore √™tre r√©solue lorsque la fonction **router.navigate** est appel√©e.
Notre serveur est tourne en locale, donc la requ√™te sera rapide, mais elle reste asynchrone.

Une requ√™te adress√©e au serveur peut prendre beaucoup de temps si le serveur ou le r√©seau est lent pour une raison quelconque.
Dans cette situation, pendant que la demande est toujours en cours de traitement, la fonction **router.navigate** sera ex√©cut√©e.

Ce n'est pas ce que vous souhaitez car en naviguant, vous allez afficher la liste des t√¢ches mise √† jour.

Vous devez attendre la r√©ponse du serveur avant de naviguer vers la route **"/"**.

## L'abonnement

La fonction d'abonnement accepte une fonction de rappel comme param√®tre.
Cette fonction de rappel sera ex√©cut√©e lorsque l'observable √©mettra une valeur.

Utilisez cette fonction de rappel pour naviguer vers la route **"/"**.

### üéì Instructions

<Steps>

1. Modifiez le fichier `src/app/task-form/task-form.component.ts`.

    ```typescript ins={"Mettez √† jour la fonction de soumission du formulaire": 29-32}
    import { Component } from '@angular/core';
    import { Router } from '@angular/router';
    import { TaskService } from '../task.service';
    import { TaskForm } from '../task.model';

    @Component({
      selector: 'app-task-form',
      templateUrl: './task-form.component.html',
      styleUrls: ['./task-form.component.css']
    })
    export class TaskFormComponent {
      task: TaskForm = {
        title: '',
        description: ''
      };

      constructor(private taskService: TaskService, private router: Router) { }

      submit() {
          const id = this.route.snapshot.paramMap.get('id');

            if (id) {
                const existingTask = this.taskService.getTask(id);
                this.taskService.updateTask({
                    ...existingTask,
                    ...this.task
                });
            } else {

                this.taskService.addTask(this.task).subscribe(() => {
                    this.router.navigate(['/']);
                });
            }
      }
    }
    ```
    :::caution
    Ce changement introduit temporairement une r√©gression dans l'application.
    La mise √† jour d'une t√¢che ne d√©clenche plus la navigation du routeur.
    Vous y rem√©dierez dans le prochain chapitre.
    :::
</Steps>

## ‚úîÔ∏è Ce que vous avez appris

Dans ce chapitre, vous avez appris √† utiliser **HttpClient** pour ajouter une t√¢che √† la liste. La communication API √©tant asynchrone, vous avez appris √† utiliser la fonction **subscribe** pour attendre la r√©ponse du serveur avant de naviguer vers la route **"/"**.
